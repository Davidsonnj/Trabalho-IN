import mysql.connector
import localizacao

# Conexão com o banco relacional
conn_relacional = mysql.connector.connect(
    host='trabalho-kelly-banco-de-dados-2024-1.l.aivencloud.com',
    port=25694,
    user='avnadmin',
    password='AVNS_qxYqWSPuEOEooRWhlXK',
    database='dbnetf',
)

# Conexão com o banco dimensional
conn_dimensional = mysql.connector.connect(
    host='modelo-dimensional-in-davidsonifes.d.aivencloud.com',
    port=13844,
    user='avnadmin',
    password='AVNS_bDOXo9cSeE-GQIBLhRB',
    database='dbnetf',
)

cursor_relacional = conn_relacional.cursor()
cursor_dimensional = conn_dimensional.cursor()

# Consulta no banco relacional
cursor_relacional.execute('''
SELECT a.idAssinatura, u.dtnascimento, p.nmPais, a.dtInicio
FROM Assinatura a
JOIN Usuario u ON a.Usuario_idUsuario = u.idUsuario
JOIN Pais p ON u.pais_idpais = p.idPais
''')

resultados = cursor_relacional.fetchall()

for (idAssinatura, dtnascimento, nmPais, dtInicio) in resultados:

    # --- Dim_Localizacao ---
    cursor_dimensional.execute("SELECT idLocalizacao FROM Dim_Localizacao WHERE pais = %s", (nmPais,))
    row = cursor_dimensional.fetchone()
    if row:
        idLocalizacao = row[0]
    else:
        continente = localizacao.obter_continente(nmPais)
        cursor_dimensional.execute("INSERT INTO Dim_Localizacao (pais, continente) VALUES (%s, %s)", (nmPais, continente))
        conn_dimensional.commit()
        idLocalizacao = cursor_dimensional.lastrowid

    # --- Dim_Usuario ---
    cursor_dimensional.execute("SELECT idUsuario FROM Dim_Usuario WHERE dtNascimento = %s LIMIT 1", (dtnascimento,))
    row = cursor_dimensional.fetchone()
    if row:
        idUsuario = row[0]
    else:
        cursor_dimensional.execute("INSERT INTO Dim_Usuario (dtNascimento) VALUES (%s)", (dtnascimento,))
        conn_dimensional.commit()
        idUsuario = cursor_dimensional.lastrowid

    # --- Dim_Data (Data de Assinatura) ---
    mes = dtInicio.month
    ano = dtInicio.year

    cursor_dimensional.execute("SELECT idDim_Data FROM Dim_Data WHERE mes = %s AND ano = %s", (mes, ano))
    row = cursor_dimensional.fetchone()
    if row:
        idData = row[0]
    else:
        cursor_dimensional.execute("INSERT INTO Dim_Data (mes, ano) VALUES (%s, %s)", (mes, ano))
        conn_dimensional.commit()
        idData = cursor_dimensional.lastrowid

    # --- Fato_Assinatura ---
    cursor_dimensional.execute("""
        INSERT INTO Fato_Assinatura (
            Dim_Localizacao_idLocalizacao,
            Dim_DataAssinatura_idDim_Data,
            Dim_Usuario_idUsuario,
            qtd_novos_assinantes
        ) VALUES (%s, %s, %s, %s)
    """, (idLocalizacao, idData, idUsuario, 1))
    conn_dimensional.commit()
